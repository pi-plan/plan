# PiLCS 在异地多活架构中落地

在单数据中心的场景下，PiLCS 和 Client 之间的通讯都是在同一个网络环境中进行的，网络延迟、同步等都是有着相对较低的延迟。但是把 PiLCS 落地到异地多活环境中的时候就会遇到新的问题。

## 新问题
讨论新问题之前，首先讨论下 PiLCS 在异地多活架构中如何部署，不同的部署方式又会带来不同的问题。
### 多数据中心共用一组实例
这种部署模式下，多个数据中心只会有一个数据中心是 Leader，其他的数据中心在获取逻辑时间的时候，就需要发生跨数据中心的网络调用，这中调用相对本数据中心的调用来说是高成本的，不仅延迟高、可靠性也会降低。所以这种方式对性能影响很大。不建议采用。

### 每个数据中心单独部署实例
在部署到异地多活架构中，每个数据中心的数据都会在其他数据中心同步。而且每条数据也可能切换到其他数据中心去处理，如果此时两个数据中心的 PiLCS 不同步，获取到的逻辑时间发生了回流，这对于业务来说是不可接受的。
所以总结来说，在异地多活环境中 PiLCS 遇到的问题是，为了保障调用的性能需要每个数据中心独立部署，再次基础上，每个数据中心的时间也不能发生回滚。对于 PiLCS 的要求就是：同一条数据，在 A 时间点之后的操作，无论发生在任何一个数据中心，获取到的逻辑时间都必须大于 A。

## 分析
从上面的对 PiLCS 的要求来说，只需要保证同一条数据获取先后获取的逻辑时候一定是递增的即可。我们在回到异地多活的场景中来说，如果一直在同一个数据中心就不会出现问题，问题只会在数据的 Zone Sharding 发生切换的时候才会产生。那么在数据发生切换的时候每个数据中心对齐一下分发的进度，每个节点把进度分配到最新的进度上。

## 答案
通过上面的要求和分析，我们可以设计出来大致的方案。
1. 在发生切换的时候，每个数据中心对齐到最新的分发进度。
2. 对齐的时候不能阻塞新的信号分发。
3. 对齐之后开始切换 Zone Sharding 规则。
4. 从对齐后的进度继续分发。
有了方案之后，结合 PiLCS 来实现的细节是。

### 对齐步骤
在多话切换的时候，完成 BLOCK 状态操作之后，执行对齐操作，首先PiMMS 获取每个数据中心最新的进度，并且对比出最大值。在这个过程中每个数据中心的 PiLCS 服务是继续分发的，也是会增长的。不过这个并不会影响到对齐的操作，因为设计到 Zone Sharding 的数据已经是 BLOCK 了，所以此时拿到的最新进度一定是大于被 Zone Sharding 的数据的最大值的。
拿到最大值之后，PIMMS 判断是否那个数据中心需要对齐。对于需要对齐的数据中心，执行对齐操作。
对于 PiLCS 实例而言，收到 PiMMS 的对齐要求之后，需要判断一下，因为自己也一直在分发逻辑时间，如果本地的记录已经超过要对齐的时间了，就不需要对齐了，只有当前进度还没有达到要对齐的数据的时候，采取执行对齐。对齐之后从新的进度进行分发。
至此数据分发完毕。